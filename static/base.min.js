const logSelect=document.getElementById("log-select"),requestCount=document.getElementById("request-count"),activeUsers=document.getElementById("active-users"),averageResponseTime=document.getElementById("average-response-time"),percentSuccess=document.getElementById("percent-success"),requestByStatus=document.querySelector("#request-by-status > canvas");let requestByStatusChart=null;const totalRequests=document.querySelector("#total-requests > canvas");let totalRequestsChart=null;const errorRate=document.querySelector("#error-rate > canvas");let errorRateChart=null;const referringSites=document.getElementById("referring-sites"),popularRoutes=document.getElementById("popular-routes"),styles=getComputedStyle(document.documentElement);Chart.defaults.borderColor=styles.getPropertyValue("--table-border"),Chart.defaults.background=styles.getPropertyValue("--table-background"),Chart.defaults.color=styles.getPropertyValue("--foreground");let logs=[];const isMultiDay=()=>logSelect.value.endsWith("-days"),httpRequestLogs=()=>logs.filter((e=>"http request"===e?.span?.name)),nonStaticHttpRequests=()=>httpRequestLogs().filter((e=>!1===e?.span?.["http.url"]?.startsWith("/static/")));async function getLogs(e){let t="/admin/logs/today";e.endsWith("-days")?t=`/admin/logs?days=${e.substring(0,e.lastIndexOf("-"))}`:"today"!==e&&(t=`/admin/logs/${e}`),(await callApi(t)).forEach((e=>{e.timestamp=luxon.DateTime.fromISO(e.timestamp)}))}function clearTable(e){e.querySelector("tbody").innerHTML=""}function getActiveUsers(){return new Set(httpRequestLogs().map((e=>e?.span?.user_id)).filter((e=>"number"==typeof e))).size}function getAverageResponseTime(){let e=nonStaticHttpRequests().map((e=>(e?.span?.["http.latency"]??0)/1e3));return Math.round(e.reduce(((e,t)=>e+t),0)/e.length)}const isSpanSuccess=e=>{let t=e?.span?.["http.status_code"];return null!==t&&t>=200&&t<400};function getSuccessRate(){let e=nonStaticHttpRequests();return e.reduce(((e,t)=>e+isSpanSuccess(t)),0)/e.length}function getAppropriateTimeScales(){let e=isMultiDay()?"day":"hour";return{x:{type:"time",time:{unit:e,tooltipFormat:"DD T"},title:{display:!0,text:"day"==e?"Date":"Time"}},y:{title:{display:!0,text:"Total"},ticks:{precision:0}}}}function getGroupedByRequestStatusData(){let e={},t=isMultiDay()?"day":"hour";return httpRequestLogs().forEach((n=>{let a=n.timestamp.startOf(t).toISO(),r=n?.span?.["http.status_code"]||0;if(0===r)return;let l=100*Math.floor(r/100);if(e.hasOwnProperty(l)){let t=e[l];t.hasOwnProperty(a)?t[a]+=1:t[a]=1}else e[l]={},e[l][a]=1})),e}function getGroupedByRequestTotalData(){let e={},t=isMultiDay()?"day":"hour";return httpRequestLogs().forEach((n=>{let a=n.timestamp.startOf(t).toISO();e.hasOwnProperty(a)?e[a]+=1:e[a]=1})),e}function getGroupedByErrorRateData(){let e={};httpRequestLogs().forEach((t=>{let n=t.timestamp.startOf("minute").toISO(),a=t?.span?.["http.status_code"]||0;if(0===a)return;let r=100*Math.floor(a/100);if(e.hasOwnProperty(n)){let t=e[n];t.hasOwnProperty(r)?t[r]+=1:t[r]=1}else e[n]={},e[n][r]=1}));for(const[t,n]of Object.entries(e)){let a=Object.values(n).reduce(((e,t)=>e+t),0);e[t]={400:(n[400]??0)/a,500:(n[500]??0)/a}}return e}function getRequestByStatusData(){let e,t=logSelect.value;if(t.endsWith("-days")){let n=parseInt(t.substring(0,t.lastIndexOf("-")));e=Array.from({length:n},((e,t)=>luxon.DateTime.utc().minus({days:t}).toJSDate()))}else{let t=luxon.DateTime.utc(),n=t.startOf("day"),a=t.diff(n,["hours"]).toObject().hours;e=Array.from({length:a},((e,t)=>n.plus({hours:t}).toJSDate()))}let n={200:"28, 121, 81",300:"28, 115, 121",400:"207,157,34",500:"164,57,47"},a=getGroupedByRequestStatusData(),r=Object.entries(a).map((([t,a])=>{let r=t.toString().substring(0,1)+"XX",l=n[t],o=l?`rgb(${l})`:void 0,s=l?`rgba(${l}, 0.5)`:void 0,i=Object.entries(a).map((([e,t])=>({x:e,y:t})));for(const t of e){let e=luxon.DateTime.fromJSDate(t);i.some((t=>e.toMillis()==luxon.DateTime.fromISO(t.x).toMillis()))||i.push({x:e.toISO(),y:0})}return i.sort(((e,t)=>e.x.localeCompare(t.x))),{label:`HTTP ${r}`,fill:!0,borderColor:o,backgroundColor:s,pointStyle:!1,spanGaps:!0,tension:.2,data:i}}));return{labels:e,datasets:r}}function getTotalRequestData(){let e,t=logSelect.value;if(t.endsWith("-days")){let n=parseInt(t.substring(0,t.lastIndexOf("-")));e=Array.from({length:n},((e,t)=>luxon.DateTime.utc().minus({days:t}).toJSDate()))}else{let t=luxon.DateTime.utc().startOf("day");e=Array.from({length:24},((e,n)=>t.plus({hours:n}).toJSDate()))}let n=getGroupedByRequestTotalData();return{labels:e,datasets:[{label:"Requests",data:Object.entries(n).map((([e,t])=>({x:e,y:t})))}]}}function getErrorRateData(){let e,t=logSelect.value;if(t.endsWith("-days")){let n=parseInt(t.substring(0,t.lastIndexOf("-")));e=Array.from({length:n},((e,t)=>luxon.DateTime.utc().minus({days:t}).toJSDate()))}else{let t=luxon.DateTime.utc(),n=t.startOf("day"),a=t.diff(n,["hours"]).toObject().hours;e=Array.from({length:a},((e,t)=>n.plus({hours:t}).toJSDate()))}let n=["207,157,34","164,57,47"],a=getGroupedByErrorRateData(),r=[],l=[];for(const[e,t]of Object.entries(a))r.push({x:e,y:t[400]??0}),l.push({x:e,y:t[500]??0});for(const t of e){let e=luxon.DateTime.fromJSDate(t).toISO();a.hasOwnProperty(e)||(r.push({x:e,y:0}),l.push({x:e,y:0}))}return r.sort(((e,t)=>e.x.localeCompare(t.x))),l.sort(((e,t)=>e.x.localeCompare(t.x))),{labels:e,datasets:[r,l].map(((e,t)=>{let a=n[t];return{label:0==t?"HTTP 4XX":"HTTP 5XX",fill:!0,borderColor:a?`rgb(${a})`:void 0,backgroundColor:a?`rgba(${a}, 0.5)`:void 0,pointStyle:!1,spanGaps:!0,tension:.4,data:e}}))}}function getRequestByStatus(){const e={type:"line",data:getRequestByStatusData(),options:{plugins:{title:{text:"HTTP Status Codes",display:!0},zoom:{zoom:{wheel:{enabled:!0},pinch:{enabled:!0},pan:{enabled:!0,modifierKey:"ctrl"},limits:{min:"original"},mode:"xy"}}},scales:getAppropriateTimeScales()}};null!==requestByStatusChart?(requestByStatusChart.data=e.data,requestByStatusChart.options=e.options,requestByStatusChart.update()):requestByStatusChart=new Chart(requestByStatus,e)}function getTotalRequests(){const e={type:"bar",data:getTotalRequestData(),options:{plugins:{title:{text:"Total HTTP Requests",display:!0}},scales:getAppropriateTimeScales()}};null!==totalRequestsChart?(totalRequestsChart.data=e.data,totalRequestsChart.options=e.options,totalRequestsChart.update()):totalRequestsChart=new Chart(totalRequests,e)}function getErrorRate(){let e=isMultiDay()?"day":"hour";const t={x:{type:"time",time:{unit:e,tooltipFormat:"DD T"},title:{display:!0,text:"day"==e?"Date":"Time"}},y:{title:{display:!0,text:"Percentage"},min:0,suggestedMax:.5,ticks:{callback:e=>e.toLocaleString(void 0,{style:"percent"})}}},n={type:"line",data:getErrorRateData(),options:{plugins:{title:{text:"Error Rate",display:!0},zoom:{zoom:{wheel:{enabled:!0},pinch:{enabled:!0},pan:{enabled:!0,modifierKey:"ctrl"},limits:{min:"original"},mode:"xy"}}},scales:t}};null!==errorRateChart?(errorRateChart.data=n.data,errorRateChart.options=n.options,errorRateChart.update()):errorRateChart=new Chart(errorRate,n)}function getSearchEngine(e){try{return e.host.startsWith("google")?"Google":"bing.com"==e.host?"Bing":"duckduckgo.com"==e.host?"DuckDuckGo":null}catch(e){return null}}function getReferringSites(){let e=nonStaticHttpRequests().map((e=>e?.span?.["http.referrer"]||"")).filter((e=>!e.startsWith(window.location.origin)&&0!=e.length)).reduce(((e,t)=>(e.hasOwnProperty(t)?e[t]+=1:e[t]=1,e)),{}),t=referringSites.querySelector("tbody");t.innerHTML="";for(const[n,a]of Object.entries(e).sort((([,e],[,t])=>t-e)).slice(0,25)){let e=document.createElement("tr"),r=document.createElement("td");if(r.setAttribute("data-th","Site"),n.startsWith("http")){let e=new URL(n),t=getSearchEngine(e);if(null===t){let t=document.createElement("a");t.href=n,t.textContent=e.host,r.appendChild(t)}else r.textContent=t}else r.textContent=n;let l=document.createElement("td");l.setAttribute("data-th","Views"),l.textContent=a.toLocaleString(),e.appendChild(r),e.appendChild(l),t.appendChild(e)}}function getPopularRoutes(){let e=nonStaticHttpRequests().map((e=>e?.span?.["http.url"]||"")).filter((e=>0!=e.length)).reduce(((e,t)=>(e.hasOwnProperty(t)?e[t]+=1:e[t]=1,e)),{}),t=popularRoutes.querySelector("tbody");t.innerHTML="";for(const[n,a]of Object.entries(e).sort((([,e],[,t])=>t-e)).slice(0,25)){let e=document.createElement("tr"),r=document.createElement("td");r.setAttribute("data-th","Route");let l=document.createElement("a");l.href=n,l.textContent=n,r.appendChild(l);let o=document.createElement("td");o.setAttribute("data-th","Views"),o.textContent=a.toLocaleString(),e.appendChild(r),e.appendChild(o),t.appendChild(e)}}function updateGraphs(){requestCount.textContent=httpRequestLogs().length.toLocaleString(),activeUsers.textContent=getActiveUsers(),averageResponseTime.textContent=`${getAverageResponseTime()} ms`,percentSuccess.textContent=getSuccessRate().toLocaleString(void 0,{style:"percent",minimumFractionDigits:2}),getRequestByStatus(),getTotalRequests(),getReferringSites(),getPopularRoutes(),getErrorRate()}logSelect.addEventListener("change",(async()=>{await getLogs(logSelect.value),updateGraphs()})),getLogs(logSelect.value).then(updateGraphs);const username=document.getElementById("username");username?.addEventListener("input",(()=>{username.validity.patternMismatch?username.setCustomValidity("Must be all lowercase letters, numbers, or .-_ characters"):username.setCustomValidity("")})),document.querySelectorAll(".password-icon").forEach((e=>{e.addEventListener("click",(()=>{let t=e.previousElementSibling,n=e.firstElementChild;"password"===t.type?(t.type="text",n.src="/static/visibility_off.svg"):(t.type="password",n.src="/static/visibility.svg")}))})),document.getElementById("change-password")?.addEventListener("click",(()=>{document.getElementById("change-password-modal").showModal()})),document.querySelector('#change-password-modal .button[formmethod="dialog"]')?.addEventListener("click",(()=>{document.getElementById("change-password-modal").close()}));const toggleEditor=document.getElementById("toggle-editor");toggleEditor?.addEventListener("click",(async()=>{let e="false"==toggleEditor.getAttribute("data-editor");if(null!==await callApi(toggleEditor.getAttribute("data-endpoint"),{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({editor:e})})){showAlert({level:"success",content:`Successfully ${e?"made user an editor":"removed editor flag from user"}.`}),await sleep(2e3),window.location.reload()}}));const anilistRegex=/^https:\/\/anilist\.co\/anime\/(\d+)\//m,main=document.querySelector("main"),settings=document.getElementById("settings"),settingsModal=document.getElementById("settings-modal"),getAnilistId=e=>{const t=e.match(anilistRegex);return null==t||2!==t.length?null:parseInt(t[1],10)};function debounced(e,t=300){let n;return(...a)=>{clearTimeout(n),n=setTimeout((()=>{e.apply(this,a)}),t)}}function createAlert({content:e,level:t="info"}){const n=document.createElement("div");if(n.classList.add("alert"),n.classList.add(t),n.setAttribute("role","alert"),e){const t=document.createElement("p");t.innerHTML=e,n.appendChild(t)}const a=document.createElement("button");return a.setAttribute("aria-hidden","true"),a.setAttribute("type","button"),a.classList.add("close"),a.addEventListener("click",(()=>n.parentElement.removeChild(n))),n.appendChild(a),n}function closeAlert(e){e.preventDefault();let t=e.target.parentElement,n=t?.parentElement;n?.removeChild(t)}function showAlert({level:e,content:t}){const n=createAlert({level:e,content:t});main.insertBefore(n,main.firstChild)}function detectOS(){const e=window.navigator.userAgent;return/Macintosh/.test(e)?"macOS":-1!==["iPhone","iPad","iPod"].indexOf(e)?"iOS":-1!==["Win32","Win64","Windows"].indexOf(e)?"windows":/Android/.test(e)?"android":/Linux/.test(platform)?"linux":null}const defaultAlertHook=e=>main.insertBefore(e,main.firstChild);async function callApi(e,t,n){let a=await fetch(e,t),r=n??defaultAlertHook;if(a.ok)return"application/json"===a.headers.get("content-type")?await a.json():await a.text();{let e=`Server responded with status code ${a.status}`;if("application/json"===a.headers.get("content-type")){e=(await a.json()).error}return r(createAlert({level:"error",content:e})),null}}function sleep(e){return new Promise((t=>setTimeout(t,e)))}settings.addEventListener("click",(()=>settingsModal.showModal()));const preferredName=document.getElementById("preferred-name");function getPreferredNameForEntry(e){let t=localStorage.getItem("preferred_name")??"romaji";return"romaji"==t?e.name:"native"==t?e.japanese_name??e.name:"english"==t?e.english_name??e.name:e.name}preferredName.value=localStorage.getItem("preferred_name")??"romaji",preferredName.addEventListener("change",(()=>{localStorage.setItem("preferred_name",preferredName.value),settings.dispatchEvent(new CustomEvent("preferred-name",{detail:preferredName.value}))}));const editModal=document.getElementById("edit-entry-modal"),moveModal=document.getElementById("move-entries-modal"),deleteModal=document.getElementById("confirm-delete-modal"),editButton=document.getElementById("edit-entry"),deleteFilesButton=document.getElementById("delete-files"),downloadFilesButton=document.getElementById("download-files"),moveFilesButton=document.getElementById("move-files"),uploadForm=document.getElementById("upload-form"),uploadInput=document.getElementById("upload-file-input"),anilistSync=document.getElementById("anilist-sync"),checkedSelector='.entry:not(.hidden) > .file-bulk > input[type="checkbox"]',query="\nquery ($id: Int) {\n  Media (id: $id, type: ANIME) {\n    id\n    title {\n      romaji\n      english\n      native\n    }\n  }\n}",relationQuery="\nquery ($id: Int) {\n  Media(id: $id) {\n    relations {\n      edges {\n        relationType\n        node {\n          id\n          type\n          title {\n            romaji\n            native\n            english\n          }\n        }\n      }\n    }\n  }\n}\n";function getSelectedFiles(){return[...document.querySelectorAll(checkedSelector+":checked")].map((e=>e.parentElement.parentElement.querySelector(".file-name").textContent))}function removeCheckedFiles(){document.querySelectorAll(checkedSelector+":checked").forEach((e=>{let t=e.parentElement.parentElement;return t.parentElement.removeChild(t)})),setCheckboxState()}const disableButtons=e=>{moveFilesButton&&(moveFilesButton.disabled=e),downloadFilesButton.disabled=e};function showModalAlert(e,{level:t,content:n}){let a=createAlert({level:t,content:n}),r=e.querySelector("h1");r.parentNode.insertBefore(a,r.nextSibling)}function modalAlertHook(e){let t=e.querySelector("h1");return e=>t.parentNode.insertBefore(e,t.nextSibling)}async function getAnimeInfo(e){let t=await fetch("https://graphql.anilist.co",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({query:query,variables:{id:e}})});if(t.ok){let e=await t.json(),n=e?.data?.Media?.title;n?.romaji&&(document.getElementById("entry-name").value=n.romaji),n?.native&&(document.getElementById("entry-japanese-name").value=n.native),n?.english&&(document.getElementById("entry-english-name").value=n.english),showModalAlert(editModal,{level:"success",content:"Updated names from AniList"})}else showModalAlert(editModal,{level:"error",content:`AniList returned ${t.status}`})}async function getAnimeRelationIds(e){let t=await fetch("https://graphql.anilist.co",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({query:relationQuery,variables:{id:e}})});if(t.ok){let e=await t.json();return(e?.data?.Media?.relations?.edges??[]).map((e=>e.node.id))}return console.log(`AniList returned ${t.status}`),[]}async function populateAnimeRelations(){if(null==entryData.anilist_id)return;let e=await getAnimeRelationIds(entryData.anilist_id);if(0===e.length)return;let t=await fetch("/entry/relations",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({anilist_ids:e})});if(!t.ok)return void console.log(`Server returned ${t.status} for relations`);let n=await t.json();if(0===n.length)return;let a=document.getElementById("relations");a.innerHTML="<span>Related</span>";for(const e of n){let t=document.createElement("a");t.href=`/entry/${e.id}`,t.textContent=getPreferredNameForEntry(e),t.classList.add("relation"),t.classList.add("file-name"),t.setAttribute("data-name",e.name),null!==e.japanese_name&&t.setAttribute("data-japanese-name",e.japanese_name),null!==e.english_name&&t.setAttribute("data-english-name",e.english_name),a.appendChild(t)}}async function downloadFiles(){let e=getSelectedFiles();if(0===e.length)return;let t={files:e};await fetch(`/entry/${entryId}/bulk`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(t)});if(resp.ok){const e=document.createElement("a");let t=await resp.blob();e.href=URL.createObjectURL(t),e.download=resp.headers.get("x-jimaku-filename"),e.classList.add("hidden"),document.body.appendChild(e),e.click(),document.body.removeChild(e)}else{let e=`Server responded with status code ${resp.status}`;if("application/json"===resp.headers.get("content-type")){e=(await resp.json()).error}showAlert({level:"error",content:e})}bulkCheck.click()}editButton?.addEventListener("click",(()=>editModal?.showModal())),anilistSync?.addEventListener("click",(async e=>{e.preventDefault();let t=parseInt(document.getElementById("entry-anilist-id").value,10);t?await getAnimeInfo(t):showModalAlert(editModal,{level:"error",content:"Missing or invalid AniList ID"})}));const bulkCheck=document.getElementById("bulk-check");function setCheckboxState(){let e=[...document.querySelectorAll(checkedSelector)],t=e.reduce(((e,t)=>e+t.checked),0),n=0===t;disableButtons(n),n?(bulkCheck.checked=!1,bulkCheck.indeterminate=!1,bulkCheck.removeAttribute("tribool")):t===e.length?(bulkCheck.indeterminate=!1,bulkCheck.removeAttribute("tribool"),bulkCheck.checked=!0):(bulkCheck.indeterminate=!0,bulkCheck.setAttribute("tribool","yes"),bulkCheck.checked=!1)}async function deleteFiles(){let e=getSelectedFiles(),t={files:e};0===e.length&&(t.delete_parent=!0);let n=await callApi(`/entry/${entryId}`,{method:"DELETE",headers:{"content-type":"application/json"},body:JSON.stringify(t)});if(null!==n){if(t.delete_parent)showAlert({level:"success",content:"Successfully deleted entry, redirecting you back home..."});else{let e=n.success+n.failed;showAlert({level:"success",content:`Successfully deleted ${n.success}/${e} file${1==e?"s":""}`})}deleteModal.close(),removeCheckedFiles(),t.delete_parent&&(await sleep(3e3),window.location.href="/")}}async function moveFiles(){let e=getSelectedFiles();if(0===e.length)return;let t=new URLSearchParams,n={files:e},a=getAnilistId(document.getElementById("anilist-url")?.value);null!==a&&(n.anilist_id=a,t.append("anilist_id",a));let r=document.getElementById("directory-name").value;r&&(n.name=r,t.append("name",r));let l=await fetch("/entry/search?"+t);if(l.ok){let e=await l.json();n.entry_id=e.entry_id}let o=await callApi(`/entry/${entryId}/move`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(n)},modalAlertHook);if(null===o)return;let s=o.success+o.failed;showModalAlert(moveModal,{level:"success",content:`Successfully moved ${o.success}/${s} files, redirecting to folder in 5 seconds...`}),await sleep(5e3),window.location.href=`/entry/${o.entry_id}`}bulkCheck.addEventListener("click",(()=>{let e="yes"===bulkCheck.getAttribute("tribool"),t=!e&&bulkCheck.checked;document.querySelectorAll(checkedSelector).forEach((e=>{e.checked=t})),disableButtons(!t),e&&(bulkCheck.checked=!1,bulkCheck.indeterminate=!1,bulkCheck.removeAttribute("tribool"))})),populateAnimeRelations(),deleteFilesButton?.addEventListener("click",(()=>{let e=getSelectedFiles();deleteModal.querySelector("span").textContent=1===e.length?"1 file":0===e.length?"the entire entry":`${e.length} files`,deleteModal.showModal()})),document.getElementById("confirm-move")?.addEventListener("click",(e=>{e.preventDefault(),moveFiles()})),document.getElementById("confirm-delete")?.addEventListener("click",(e=>{e.preventDefault(),deleteFiles()})),moveFilesButton?.addEventListener("click",(()=>moveModal?.showModal())),document.getElementById("clear-search-filter").addEventListener("click",setCheckboxState),filterElement.addEventListener("input",setCheckboxState),document.querySelectorAll('.file-bulk > input[type="checkbox"]').forEach((e=>{e.addEventListener("click",setCheckboxState)})),uploadInput?.addEventListener("change",(()=>{uploadForm.submit()})),downloadFilesButton.addEventListener("click",downloadFiles);const filterElement=document.getElementById("search-files"),escapedRegex=/[-\/\\^$*+?.()|[\]{}]/g,rtf=new Intl.RelativeTimeFormat(void 0,{style:"long",numberic:"auto"}),escapeRegex=e=>e.replace(escapedRegex,"\\$&");function formatRelative(e){const t=Math.round(e-Date.now()/1e3),n=[60,3600,86400,604800,2419200,31536e3,1/0],a=n.findIndex((e=>e>Math.abs(t))),r=a?n[a-1]:1;return rtf.format(Math.floor(t/r),["second","minute","hour","day","week","month","year"][a])}function __score(e,t){let n=fuzzysort.single(t,e);return null==n?.score?-1e3:n.score}const changeModifiedToRelative=()=>{document.querySelectorAll(".file-modified").forEach((e=>{const t=parseInt(e.parentElement.getAttribute("data-last-modified"),10);e.textContent=formatRelative(t)}))},changeDisplayNames=e=>{let t={romaji:"data-name",native:"data-japanese-name",english:"data-english-name"}[e];document.querySelectorAll(".entry > .file-name").forEach((e=>{let n=e.parentElement;e.textContent=n.getAttribute(t)??n.getAttribute("data-name")}));let n=document.querySelector(".entry-info > .title");null!==n&&(n.textContent=getPreferredNameForEntry(entryData)),document.querySelectorAll(".relation.file-name").forEach((e=>{e.textContent=e.getAttribute(t)??e.getAttribute("data-name")}))},parseEntryObjects=()=>{document.querySelectorAll(".entry[data-extra]").forEach((e=>{const t=JSON.parse(e.getAttribute("data-extra"));for(const n in t)null!==t[n]&&e.setAttribute(`data-${n.replaceAll("_","-")}`,t[n]);e.removeAttribute("data-extra")}))};function innerSortBy(e,t){let n=[...document.querySelectorAll(".entry")];if(0===n.length)return;let a=n[0].parentElement;n.sort(((n,a)=>{if("data-name"===e){let e=n.textContent,r=a.textContent;return t?e.localeCompare(r):r.localeCompare(e)}{let r=parseInt(n.getAttribute(e),10),l=parseInt(a.getAttribute(e),10);return t?r-l:l-r}})),n.forEach((e=>a.appendChild(e)))}function sortBy(e,t){let n=!e.target.classList.contains("sorting-ascending");document.querySelectorAll(".table-headers > .table-header").forEach((e=>e.classList.remove("sorting-ascending","sorting-descending"))),innerSortBy(`data-${t}`,n);let a=n?"sorting-ascending":"sorting-descending";e.target.classList.add(a)}let previousEntryOrder=null;function resetSearchFilter(){0===filterElement.value.length&&filterElement.focus();let e=[...document.querySelectorAll(".entry")];if(0!==e.length){let t=e[0].parentNode;e.forEach((e=>e.classList.remove("hidden"))),null!==previousEntryOrder&&(previousEntryOrder.forEach((e=>t.appendChild(e))),previousEntryOrder=null)}filterElement.value=""}const __scoreByName=(e,t)=>{let n=__score(e.getAttribute("data-name"),t),a=e.getAttribute("data-japanese-name");null!==a&&(n=Math.max(n,__score(a,t)));let r=e.getAttribute("data-english-name");return null!==r&&(n=Math.max(n,__score(r,t))),n};function filterEntries(e){if(!e)return void resetSearchFilter();let t=[...document.querySelectorAll(".entry")];if(null===previousEntryOrder&&(previousEntryOrder=t),0===t.length)return;let n=t[0].parentNode,a=getAnilistId(e),r=[];r=null!==a?t.map((e=>{let t=e.getAttribute("data-anilist-id");return{entry:e,score:null!==t&&parseInt(t,10)===a?0:-1e3}})):t.map((t=>({entry:t,score:__scoreByName(t,e)}))),r.sort(((e,t)=>t.score-e.score)).forEach((e=>{e.entry.classList.toggle("hidden",e.score<=-1e3),n.appendChild(e.entry)}))}parseEntryObjects(),changeModifiedToRelative();{let e=localStorage.getItem("preferred_name")??"romaji";"romaji"!=e&&changeDisplayNames(e)}innerSortBy("data-name",!0),settings.addEventListener("preferred-name",(e=>changeDisplayNames(e.detail))),document.getElementById("clear-search-filter")?.addEventListener("click",resetSearchFilter),document.querySelectorAll(".table-header[data-sort-by]").forEach((e=>{e.addEventListener("click",(t=>sortBy(t,e.getAttribute("data-sort-by"))))})),filterElement?.addEventListener("input",debounced((e=>filterEntries(e.target.value))));const uploadButton=document.getElementById("upload-button"),uploadModal=document.getElementById("upload-modal");function checkDuplicate(){const e=document.getElementById("directory-name");let t=getAnilistId(anilistUrl.value);return[...document.querySelectorAll(".entry")].find((n=>{let a=n.getAttribute("data-anilist-id"),r=n.getAttribute("data-name");return null!==a&&null!==t&&parseInt(a,10)===t||null!==e&&r===e.value}))}const anilistUrl=document.getElementById("anilist-url"),form=uploadModal.querySelector("form");form.addEventListener("submit",(e=>{e.preventDefault();const t=checkDuplicate();return null===t||(window.location.href=t.querySelector("a").href,!1)})),uploadModal.querySelector("button[formmethod=dialog]").addEventListener("click",(e=>{e.preventDefault(),uploadModal.close()})),anilistUrl.addEventListener("input",(()=>{anilistUrl.validity.patternMismatch?anilistUrl.setCustomValidity("Invalid AniList URL"):anilistUrl.setCustomValidity("")})),uploadButton?.addEventListener("click",(()=>uploadModal.showModal()));